# Lab 11

## Task 1

### Kubectl Secrets

#### Create

```shell
> kubectl create secret generic lab11-secret --from-literal=API_KEY=hello
secret/lab11-secret created
```

#### Verify

```shell
> kubectl get secrets
NAME           TYPE     DATA   AGE
lab11-secret   Opaque   1      24s
```

#### Decode

```shell
> kubectl get secret lab11-secret -o jsonpath='{.data}'
{"API_KEY":"aGVsbG8="}
```

```shell
$echo "aGVsbG8=" | base64 -d
hello
```

### Helm Secrets

Inside `k8s/app-python` folder:

```shell
>helm secrets upgrade --install app-python . -f secrets.yaml
[helm-secrets] Decrypt: secrets.yaml
Release "app-python" has been upgraded. Happy Helming!
NAME: app-python
LAST DEPLOYED: Thu Mar  6 19:20:16 2025
NAMESPACE: default
STATUS: deployed
REVISION: 2
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-python,app.kubernetes.io/instance=app-python" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
[helm-secrets] Removed: secrets.yaml.dec
```

```shell
>kubectl get po
NAME                        READY   STATUS    RESTARTS   AGE
app-python-d4996dfd-nbfjb   1/1     Running   0          4m5s
```

```shell
>kubectl exec app-python-d4996dfd-nbfjb -- printenv | grep API_KEY
API_KEY=hello
```

## Task 2

### Set Secret in Vault

```shell
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
```

```shell
/ $ vault kv put internal/database/config username="magicwinnie"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-06T16:27:56.403055551Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
```

```shell
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-06T16:27:56.403055551Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
username    magicwinnie
```

### Configure Kubernetes Authentication

```shell
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes
```

```shell
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
```

```shell
/ $  vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app
```

```shell
/ $ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=internal-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
```

### Create Service Account

```shell
>kubectl create sa internal-app
serviceaccount/internal-app created
```

```shell
>kubectl get serviceaccounts
NAME                   SECRETS   AGE
app-python             0         15m
default                0         9d
internal-app           0         12s
vault                  0         7m56s
vault-agent-injector   0         7m56s
```

## Implement Vault Secrets

```shell
>kubectl patch deployment app-python --patch-file=patch-inject-secrets.yaml
deployment.apps/app-python patched
```

```shell
>kubectl exec -it app-python-5b787dbbd4-2bjc6 --container app-python -- /bin/sh
/app $ cd ..
/ $ cat vault/secrets/database-config.txt
data: map[username:magicwinnie]
metadata: map[created_time:2025-03-06T16:27:56.403055551Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
/ $ df -h
Filesystem                Size      Used Available Use% Mounted on
overlay                1006.9G      6.4G    949.2G   1% /
tmpfs                    64.0M         0     64.0M   0% /dev
tmpfs                     1.5G         0      1.5G   0% /sys/fs/cgroup
shm                      64.0M         0     64.0M   0% /dev/shm
tmpfs                     2.9G      4.0K      2.9G   0% /vault/secrets
/dev/sdc               1006.9G      6.4G    949.2G   1% /dev/termination-log
/dev/sdc               1006.9G      6.4G    949.2G   1% /etc/resolv.conf
/dev/sdc               1006.9G      6.4G    949.2G   1% /etc/hostname
/dev/sdc               1006.9G      6.4G    949.2G   1% /etc/hosts
tmpfs                     2.9G     12.0K      2.9G   0% /run/secrets/kubernetes.io/serviceaccount
tmpfs                     1.5G         0      1.5G   0% /proc/acpi
tmpfs                    64.0M         0     64.0M   0% /proc/kcore
tmpfs                    64.0M         0     64.0M   0% /proc/keys
tmpfs                    64.0M         0     64.0M   0% /proc/timer_list
tmpfs                     1.5G         0      1.5G   0% /sys/firmware
```
